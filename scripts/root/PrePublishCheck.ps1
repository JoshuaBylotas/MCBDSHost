# Pre-Publish Checklist for MCBDS.PublicUI
# Run this before attempting to publish/package

param(
    [Parameter()]
    [ValidateSet('Debug', 'Release')]
    [string]$Configuration = 'Release'
)

Write-Host ""
Write-Host "???????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "  Pre-Publish Checklist - MCBDS.PublicUI" -ForegroundColor Cyan
Write-Host "  Configuration: $Configuration" -ForegroundColor Cyan
Write-Host "???????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host ""

$issues = 0

# Check 1: Static Web Assets Manifest
Write-Host "??????????????????????????????????????????????????" -ForegroundColor DarkGray
Write-Host "1. Checking Static Web Assets Manifest" -ForegroundColor Yellow
Write-Host "??????????????????????????????????????????????????" -ForegroundColor DarkGray

$manifestPath = "MCBDS.ClientUI\MCBDS.ClientUI.Shared\obj\$Configuration\net10.0\staticwebassets.build.json"
if (Test-Path $manifestPath) {
    Write-Host "  ? Static web assets manifest exists" -ForegroundColor Green
    $manifest = Get-Content $manifestPath -Raw | ConvertFrom-Json
    Write-Host "    Path: $manifestPath" -ForegroundColor DarkGray
} else {
    Write-Host "  ? Static web assets manifest NOT FOUND" -ForegroundColor Red
    Write-Host "    Expected: $manifestPath" -ForegroundColor Red
    Write-Host "    Solution: Run .\BuildAndPublish.ps1 -Configuration $Configuration" -ForegroundColor Yellow
    $issues++
}
Write-Host ""

# Check 2: Shared Library DLL
Write-Host "??????????????????????????????????????????????????" -ForegroundColor DarkGray
Write-Host "2. Checking Shared Library Build Output" -ForegroundColor Yellow
Write-Host "??????????????????????????????????????????????????" -ForegroundColor DarkGray

$sharedDll = "MCBDS.ClientUI\MCBDS.ClientUI.Shared\bin\$Configuration\net10.0\MCBDS.ClientUI.Shared.dll"
if (Test-Path $sharedDll) {
    $dllInfo = Get-Item $sharedDll
    Write-Host "  ? Shared library DLL exists" -ForegroundColor Green
    Write-Host "    Size: $([math]::Round($dllInfo.Length / 1KB, 1)) KB" -ForegroundColor DarkGray
    Write-Host "    Modified: $($dllInfo.LastWriteTime)" -ForegroundColor DarkGray
} else {
    Write-Host "  ? Shared library DLL NOT FOUND" -ForegroundColor Red
    Write-Host "    Expected: $sharedDll" -ForegroundColor Red
    $issues++
}
Write-Host ""

# Check 3: Main Project Build Output
Write-Host "??????????????????????????????????????????????????" -ForegroundColor DarkGray
Write-Host "3. Checking Main Project Build Output" -ForegroundColor Yellow
Write-Host "??????????????????????????????????????????????????" -ForegroundColor DarkGray

$targetFramework = "net10.0-windows10.0.19041.0"
$mainDll = "MCBDS.PublicUI\bin\$Configuration\$targetFramework\win-x64\MCBDS.PublicUI.dll"

if (Test-Path $mainDll) {
    $dllInfo = Get-Item $mainDll
    Write-Host "  ? Main project DLL exists" -ForegroundColor Green
    Write-Host "    Size: $([math]::Round($dllInfo.Length / 1KB, 1)) KB" -ForegroundColor DarkGray
    Write-Host "    Modified: $($dllInfo.LastWriteTime)" -ForegroundColor DarkGray
} else {
    Write-Host "  ? Main project DLL not found (may need rebuild)" -ForegroundColor Yellow
    Write-Host "    Expected: $mainDll" -ForegroundColor DarkGray
}
Write-Host ""

# Check 4: Windows Store Assets
Write-Host "??????????????????????????????????????????????????" -ForegroundColor DarkGray
Write-Host "4. Checking Windows Store Assets" -ForegroundColor Yellow
Write-Host "??????????????????????????????????????????????????" -ForegroundColor DarkGray

$requiredAssets = @(
    'Square44x44Logo.transparent.png',
    'Square71x71Logo.transparent.png',
    'Square150x150Logo.transparent.png',
    'Square310x310Logo.transparent.png',
    'Wide310x150Logo.transparent.png',
    'StoreLogo.transparent.png',
    'SplashScreen.transparent.png'
)

$assetsPath = "MCBDS.PublicUI\Platforms\Windows\Assets"
$missingAssets = 0

foreach ($asset in $requiredAssets) {
    $path = Join-Path $assetsPath $asset
    if (Test-Path $path) {
        Write-Host "  ? $asset" -ForegroundColor Green
    } else {
        Write-Host "  ? $asset (MISSING)" -ForegroundColor Red
        $missingAssets++
        $issues++
    }
}

if ($missingAssets -gt 0) {
    Write-Host ""
    Write-Host "  Solution: Run .\CreateMissingStoreAssets.ps1" -ForegroundColor Yellow
}
Write-Host ""

# Check 5: Package.appxmanifest
Write-Host "??????????????????????????????????????????????????" -ForegroundColor DarkGray
Write-Host "5. Checking Package Manifest" -ForegroundColor Yellow
Write-Host "??????????????????????????????????????????????????" -ForegroundColor DarkGray

$manifestPath = "MCBDS.PublicUI\Platforms\Windows\Package.appxmanifest"
if (Test-Path $manifestPath) {
    $manifest = Get-Content $manifestPath -Raw
    
    if ($manifest -match 'transparent\.png') {
        Write-Host "  ? Package manifest configured for transparent assets" -ForegroundColor Green
    } else {
        Write-Host "  ? Package manifest may need updating" -ForegroundColor Yellow
    }
    
    if ($manifest -match 'Version="([^"]+)"') {
        Write-Host "  ? Version: $($matches[1])" -ForegroundColor Cyan
    }
} else {
    Write-Host "  ? Package.appxmanifest NOT FOUND" -ForegroundColor Red
    $issues++
}
Write-Host ""

# Summary
Write-Host "???????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "  Summary" -ForegroundColor Cyan
Write-Host "???????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host ""

if ($issues -eq 0) {
    Write-Host "  ? ALL CHECKS PASSED" -ForegroundColor Green
    Write-Host "  ? Ready to publish!" -ForegroundColor Green
    Write-Host ""
    Write-Host "  Next step:" -ForegroundColor Yellow
    Write-Host "    .\BuildAndPublish.ps1 -Configuration $Configuration -CreatePackage" -ForegroundColor White
} else {
    Write-Host "  ? $issues ISSUE(S) FOUND" -ForegroundColor Red
    Write-Host "  ??  Fix issues before publishing" -ForegroundColor Yellow
    Write-Host ""
    Write-Host "  Recommended action:" -ForegroundColor Yellow
    Write-Host "    .\BuildAndPublish.ps1 -Configuration $Configuration" -ForegroundColor White
}

Write-Host ""
Write-Host "???????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host ""

exit $issues
