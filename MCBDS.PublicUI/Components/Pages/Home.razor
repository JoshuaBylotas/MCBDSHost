@page "/"
@using MCBDS.ClientUI.Shared.Services
@inject BedrockApiService ApiService
@implements IDisposable

<PageTitle>Overview</PageTitle>

<h1>Server Overview</h1>

<p>Real-time statistics for the Minecraft Bedrock Dedicated Server and API host.</p>

@if (isLoading)
{
    <div class="text-center my-5">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading server statistics...</p>
    </div>
}
else if (errorMessage != null)
{
    <div class="alert alert-danger" role="alert">
        <strong>Error:</strong> @errorMessage
        <button class="btn btn-outline-danger btn-sm ms-3" @onclick="LoadStatusAsync">
            Try Again
        </button>
    </div>
}
else if (status != null)
{
    <div class="row">
        <!-- Bedrock Server Status -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <span class="bi bi-server me-2" aria-hidden="true"></span>
                        Bedrock Server
                    </h5>
                    @if (status.Server?.IsRunning == true)
                    {
                        <span class="badge bg-success">Running</span>
                    }
                    else
                    {
                        <span class="badge bg-danger">Stopped</span>
                    }
                </div>
                <div class="card-body">
                    @if (status.Server?.IsRunning == true)
                    {
                        <div class="row mb-3">
                            <div class="col-6">
                                <div class="stat-card bg-light p-3 rounded text-center">
                                    <div class="stat-value h4 mb-0">@FormatUptime(status.Server.Uptime)</div>
                                    <div class="stat-label text-muted small">Uptime</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-card bg-light p-3 rounded text-center">
                                    <div class="stat-value h4 mb-0">@status.Server.ProcessId</div>
                                    <div class="stat-label text-muted small">Process ID</div>
                                </div>
                            </div>
                        </div>

                        <h6 class="text-muted mb-2">Memory Usage</h6>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Working Set</span>
                                <strong>@status.Server.WorkingSetMB.ToString("F1") MB</strong>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-primary" style="width: @GetMemoryPercent(status.Server.WorkingSetMB)%"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Private Memory</span>
                                <strong>@status.Server.PrivateMemoryMB.ToString("F1") MB</strong>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-info" style="width: @GetMemoryPercent(status.Server.PrivateMemoryMB)%"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Peak Working Set</span>
                                <strong>@status.Server.PeakWorkingSetMB.ToString("F1") MB</strong>
                            </div>
                        </div>

                        <h6 class="text-muted mb-2">CPU & Resources</h6>
                        <dl class="row mb-0">
                            <dt class="col-6">CPU Time</dt>
                            <dd class="col-6 text-end">@FormatTimeSpan(status.Server.TotalProcessorTime)</dd>
                            
                            <dt class="col-6">Threads</dt>
                            <dd class="col-6 text-end">@status.Server.ThreadCount</dd>
                            
                            @if (status.Server.HandleCount > 0)
                            {
                                <dt class="col-6">Handles</dt>
                                <dd class="col-6 text-end">@status.Server.HandleCount</dd>
                            }
                        </dl>
                    }
                    else
                    {
                        <div class="text-center text-muted py-4">
                            <p class="mb-2">The Bedrock server is not running.</p>
                            <p class="small">Start the server to see statistics.</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- API Host Status -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <span class="bi bi-cpu me-2" aria-hidden="true"></span>
                        API Host
                    </h5>
                    <span class="badge bg-success">Running</span>
                </div>
                <div class="card-body">
                    @if (status.Api != null)
                    {
                        <div class="row mb-3">
                            <div class="col-6">
                                <div class="stat-card bg-light p-3 rounded text-center">
                                    <div class="stat-value h4 mb-0">@FormatUptime(status.Api.Uptime)</div>
                                    <div class="stat-label text-muted small">Uptime</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-card bg-light p-3 rounded text-center">
                                    <div class="stat-value h4 mb-0">@status.Api.ProcessId</div>
                                    <div class="stat-label text-muted small">Process ID</div>
                                </div>
                            </div>
                        </div>

                        <h6 class="text-muted mb-2">Memory Usage</h6>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Working Set</span>
                                <strong>@status.Api.WorkingSetMB.ToString("F1") MB</strong>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-success" style="width: @GetMemoryPercent(status.Api.WorkingSetMB)%"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>GC Heap</span>
                                <strong>@status.Api.GCHeapSizeMB.ToString("F1") MB</strong>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-warning" style="width: @GetMemoryPercent(status.Api.GCHeapSizeMB, 500)%"></div>
                            </div>
                        </div>

                        <h6 class="text-muted mb-2">CPU & Resources</h6>
                        <dl class="row mb-0">
                            <dt class="col-6">CPU Time</dt>
                            <dd class="col-6 text-end">@FormatTimeSpan(status.Api.TotalProcessorTime)</dd>
                            
                            <dt class="col-6">Threads</dt>
                            <dd class="col-6 text-end">@status.Api.ThreadCount</dd>
                            
                            @if (status.Api.HandleCount > 0)
                            {
                                <dt class="col-6">Handles</dt>
                                <dd class="col-6 text-end">@status.Api.HandleCount</dd>
                            }
                        </dl>

                        <h6 class="text-muted mb-2 mt-3">Garbage Collection</h6>
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="small text-muted">Gen 0</div>
                                <strong>@status.Api.GCGen0Collections</strong>
                            </div>
                            <div class="col-4">
                                <div class="small text-muted">Gen 1</div>
                                <strong>@status.Api.GCGen1Collections</strong>
                            </div>
                            <div class="col-4">
                                <div class="small text-muted">Gen 2</div>
                                <strong>@status.Api.GCGen2Collections</strong>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Last Updated -->
    <div class="text-center text-muted small mt-2">
        <span>Last updated: @lastUpdated.ToString("HH:mm:ss")</span>
        <span class="mx-2">|</span>
        <span>Auto-refresh: @(autoRefreshEnabled ? "On (5s)" : "Off")</span>
        <button class="btn btn-link btn-sm p-0 ms-2" @onclick="ToggleAutoRefresh">
            @(autoRefreshEnabled ? "Pause" : "Resume")
        </button>
        <button class="btn btn-link btn-sm p-0 ms-2" @onclick="RefreshStatusAsync">
            Refresh Now
        </button>
    </div>
}

@code {
    private SystemStatusResponse? status;
    private bool isLoading = true;
    private string? errorMessage;
    private DateTime lastUpdated = DateTime.Now;
    private bool autoRefreshEnabled = true;
    private System.Threading.Timer? refreshTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadStatusAsync();
        StartAutoRefresh();
    }

    private void StartAutoRefresh()
    {
        refreshTimer = new System.Threading.Timer(async _ =>
        {
            if (autoRefreshEnabled)
            {
                await InvokeAsync(async () =>
                {
                    await RefreshStatusAsync();
                });
            }
        }, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
    }

    private async Task LoadStatusAsync()
    {
        isLoading = true;
        StateHasChanged();
        await FetchStatusAsync();
    }

    private async Task RefreshStatusAsync()
    {
        await FetchStatusAsync();
    }

    private async Task FetchStatusAsync()
    {
        errorMessage = null;

        try
        {
            status = await ApiService.GetSystemStatusAsync();
            
            if (status == null)
            {
                errorMessage = "Could not load server status. Make sure the API is running.";
            }
            else
            {
                lastUpdated = DateTime.Now;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading status: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ToggleAutoRefresh()
    {
        autoRefreshEnabled = !autoRefreshEnabled;
    }

    private static string FormatUptime(TimeSpan uptime)
    {
        if (uptime.TotalDays >= 1)
        {
            return $"{(int)uptime.TotalDays}d {uptime.Hours}h";
        }
        if (uptime.TotalHours >= 1)
        {
            return $"{(int)uptime.TotalHours}h {uptime.Minutes}m";
        }
        if (uptime.TotalMinutes >= 1)
        {
            return $"{(int)uptime.TotalMinutes}m {uptime.Seconds}s";
        }
        return $"{uptime.Seconds}s";
    }

    private static string FormatTimeSpan(TimeSpan time)
    {
        if (time.TotalHours >= 1)
        {
            return $"{(int)time.TotalHours}:{time.Minutes:D2}:{time.Seconds:D2}";
        }
        return $"{time.Minutes}:{time.Seconds:D2}";
    }

    private static int GetMemoryPercent(double memoryMB, double maxMB = 2048)
    {
        var percent = (int)((memoryMB / maxMB) * 100);
        return Math.Min(100, Math.Max(1, percent));
    }

    public void Dispose()
    {
        refreshTimer?.Dispose();
    }
}
