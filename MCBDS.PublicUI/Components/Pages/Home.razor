@page "/"
@using MCBDS.ClientUI.Shared.Services
@using MCBDS.PublicUI.Components
@inject BedrockApiService ApiService
@implements IDisposable

<PageTitle>Overview</PageTitle>

<h1>Server Overview</h1>

<p>Real-time statistics for the Minecraft Bedrock Dedicated Server and API host.</p>

@if (isLoading)
{
    <div class="text-center my-5">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading server statistics...</p>
    </div>
}
else if (errorMessage != null)
{
    <div class="alert @GetAlertClass()" role="alert">
        <div class="d-flex align-items-start">
            <div class="flex-grow-1">
                <strong><i class="bi @GetErrorIcon() me-1"></i>@GetErrorTitle()</strong>
                <p class="mb-0 mt-1">@errorMessage</p>
            </div>
            <button class="btn btn-outline-secondary btn-sm ms-3" @onclick="LoadStatusAsync">
                <i class="bi bi-arrow-clockwise me-1"></i>Retry
            </button>
        </div>
    </div>
    
    @if (errorType == ApiErrorType.ConnectionFailed)
    {
        <div class="card border-warning">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-lightbulb me-1"></i>Troubleshooting Tips</h5>
                <ul class="mb-0">
                    <li>Make sure the API server is running</li>
                    <li>Check if the server URL is correct (use the Server dropdown above to configure)</li>
                    <li>Verify there are no firewall issues blocking the connection</li>
                    <li>If running in Docker, ensure the container is healthy</li>
                </ul>
            </div>
        </div>
    }
}
else if (status != null)
{
    <!-- Online Players Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-people-fill me-2"></i>Online Players
                    </h5>
                    <span class="badge bg-light text-success">
                        <i class="bi bi-person-fill me-1"></i>@playerTracker.PlayerCount / @GetMaxPlayers()
                    </span>
                </div>
                <div class="card-body">
                    @if (playerTracker.PlayerCount > 0)
                    {
                        <div class="players-grid">
                            @foreach (var player in playerTracker.OnlinePlayers)
                            {
                                <div class="player-badge">
                                    <i class="bi bi-person-circle me-2"></i>
                                    <strong>@player</strong>
                                    <span class="player-status-dot"></span>
                                </div>
                            }
                        </div>
                        <div class="text-muted small mt-2">
                            <i class="bi bi-info-circle me-1"></i>Player list updates automatically from server log
                        </div>
                    }
                    else
                    {
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-person-x display-4"></i>
                            <p class="mb-0 mt-2">No players online</p>
                            <p class="small">Waiting for players to connect...</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Bedrock Server Status -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-controller me-2"></i>Bedrock Server
                    </h5>
                    @if (status.Server?.IsRunning == true)
                    {
                        <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Running</span>
                    }
                    else
                    {
                        <span class="badge bg-danger"><i class="bi bi-x-circle me-1"></i>Stopped</span>
                    }
                </div>
                <div class="card-body">
                    @if (status.Server?.IsRunning == true)
                    {
                        <div class="row mb-3">
                            <div class="col-6">
                                <div class="stat-card bg-light p-3 rounded text-center">
                                    <div class="stat-value h4 mb-0">@FormatUptime(status.Server.Uptime)</div>
                                    <div class="stat-label text-muted small">Uptime</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-card bg-light p-3 rounded text-center">
                                    <div class="stat-value h4 mb-0">@status.Server.ProcessId</div>
                                    <div class="stat-label text-muted small">Process ID</div>
                                </div>
                            </div>
                        </div>

                        <h6 class="text-muted mb-2"><i class="bi bi-memory me-1"></i>Memory Usage</h6>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Working Set</span>
                                <strong>@status.Server.WorkingSetMB.ToString("F1") MB</strong>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-primary" style="width: @GetMemoryPercent(status.Server.WorkingSetMB)%"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Private Memory</span>
                                <strong>@status.Server.PrivateMemoryMB.ToString("F1") MB</strong>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-info" style="width: @GetMemoryPercent(status.Server.PrivateMemoryMB)%"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Peak Working Set</span>
                                <strong>@status.Server.PeakWorkingSetMB.ToString("F1") MB</strong>
                            </div>
                        </div>

                        <h6 class="text-muted mb-2"><i class="bi bi-cpu me-1"></i>CPU & Resources</h6>
                        <dl class="row mb-0">
                            <dt class="col-6">CPU Time</dt>
                            <dd class="col-6 text-end">@FormatTimeSpan(status.Server.TotalProcessorTime)</dd>
                            
                            <dt class="col-6">Threads</dt>
                            <dd class="col-6 text-end">@status.Server.ThreadCount</dd>
                            
                            @if (status.Server.HandleCount > 0)
                            {
                                <dt class="col-6">Handles</dt>
                                <dd class="col-6 text-end">@status.Server.HandleCount</dd>
                            }
                        </dl>
                    }
                    else
                    {
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-power display-4"></i>
                            <p class="mb-2 mt-3">The Bedrock server is not running.</p>
                            <p class="small">Start the server to see statistics.</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- API Host Status -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-hdd-stack me-2"></i>API Host
                    </h5>
                    <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Running</span>
                </div>
                <div class="card-body">
                    @if (status.Api != null)
                    {
                        <div class="row mb-3">
                            <div class="col-6">
                                <div class="stat-card bg-light p-3 rounded text-center">
                                    <div class="stat-value h4 mb-0">@FormatUptime(status.Api.Uptime)</div>
                                    <div class="stat-label text-muted small">Uptime</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-card bg-light p-3 rounded text-center">
                                    <div class="stat-value h4 mb-0">@status.Api.ProcessId</div>
                                    <div class="stat-label text-muted small">Process ID</div>
                                </div>
                            </div>
                        </div>

                        <h6 class="text-muted mb-2"><i class="bi bi-memory me-1"></i>Memory Usage</h6>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Working Set</span>
                                <strong>@status.Api.WorkingSetMB.ToString("F1") MB</strong>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-success" style="width: @GetMemoryPercent(status.Api.WorkingSetMB)%"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>GC Heap</span>
                                <strong>@status.Api.GCHeapSizeMB.ToString("F1") MB</strong>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-warning" style="width: @GetMemoryPercent(status.Api.GCHeapSizeMB, 500)%"></div>
                            </div>
                        </div>

                        <h6 class="text-muted mb-2"><i class="bi bi-cpu me-1"></i>CPU & Resources</h6>
                        <dl class="row mb-0">
                            <dt class="col-6">CPU Time</dt>
                            <dd class="col-6 text-end">@FormatTimeSpan(status.Api.TotalProcessorTime)</dd>
                            
                            <dt class="col-6">Threads</dt>
                            <dd class="col-6 text-end">@status.Api.ThreadCount</dd>
                            
                            @if (status.Api.HandleCount > 0)
                            {
                                <dt class="col-6">Handles</dt>
                                <dd class="col-6 text-end">@status.Api.HandleCount</dd>
                            }
                        </dl>

                        <h6 class="text-muted mb-2 mt-3"><i class="bi bi-recycle me-1"></i>Garbage Collection</h6>
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="small text-muted">Gen 0</div>
                                <strong>@status.Api.GCGen0Collections</strong>
                            </div>
                            <div class="col-4">
                                <div class="small text-muted">Gen 1</div>
                                <strong>@status.Api.GCGen1Collections</strong>
                            </div>
                            <div class="col-4">
                                <div class="small text-muted">Gen 2</div>
                                <strong>@status.Api.GCGen2Collections</strong>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Last Updated -->
    <div class="text-center text-muted small mt-2">
        <span><i class="bi bi-clock me-1"></i>Last updated: @lastUpdated.ToString("HH:mm:ss")</span>
        <span class="mx-2">|</span>
        <span>Auto-refresh: @(autoRefreshEnabled ? "On (5s)" : "Off")</span>
        <button class="btn btn-link btn-sm p-0 ms-2" @onclick="ToggleAutoRefresh">
            <i class="bi @(autoRefreshEnabled ? "bi-pause-circle" : "bi-play-circle") me-1"></i>
            @(autoRefreshEnabled ? "Pause" : "Resume")
        </button>
        <button class="btn btn-link btn-sm p-0 ms-2" @onclick="RefreshStatusAsync">
            <i class="bi bi-arrow-clockwise me-1"></i>Refresh Now
        </button>
    </div>
}

@code {
    private SystemStatusResponse? status;
    private bool isLoading = true;
    private string? errorMessage;
    private ApiErrorType errorType = ApiErrorType.None;
    private DateTime lastUpdated = DateTime.Now;
    private bool autoRefreshEnabled = true;
    private System.Threading.Timer? refreshTimer;
    private readonly PlayerTracker playerTracker = new();
    private int maxPlayers = 10;

    protected override async Task OnInitializedAsync()
    {
        await LoadStatusAsync();
        StartAutoRefresh();
    }

    private void StartAutoRefresh()
    {
        refreshTimer = new System.Threading.Timer(async _ =>
        {
            if (autoRefreshEnabled)
            {
                await InvokeAsync(async () =>
                {
                    await RefreshStatusAsync();
                });
            }
        }, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
    }

    private async Task LoadStatusAsync()
    {
        isLoading = true;
        StateHasChanged();
        await FetchStatusAsync();
    }

    private async Task RefreshStatusAsync()
    {
        await FetchStatusAsync();
        await UpdatePlayerListAsync();
    }

    private async Task FetchStatusAsync()
    {
        errorMessage = null;
        errorType = ApiErrorType.None;

        var result = await ApiService.GetSystemStatusAsync();
        
        if (result.Success && result.Data != null)
        {
            status = result.Data;
            lastUpdated = DateTime.Now;
        }
        else
        {
            errorMessage = result.ErrorMessage ?? "Could not load server status.";
            errorType = result.ErrorType;
        }
        
        isLoading = false;
        StateHasChanged();
    }

    private async Task UpdatePlayerListAsync()
    {
        // Fetch server log to update player list
        var logResult = await ApiService.GetLogAsync();
        if (logResult.Success && !string.IsNullOrEmpty(logResult.Data))
        {
            playerTracker.ParseLog(logResult.Data);
            StateHasChanged();
        }

        // Try to get max-players from server properties if available
        var propsResult = await ApiService.GetServerPropertiesAsync();
        if (propsResult.Success && propsResult.Data?.Categories != null)
        {
            var maxPlayersProperty = propsResult.Data.Categories
                .SelectMany(c => c.Properties ?? Enumerable.Empty<ServerPropertyItem>())
                .FirstOrDefault(p => p.Key == "max-players");
            
            if (maxPlayersProperty != null && int.TryParse(maxPlayersProperty.Value, out var max))
            {
                maxPlayers = max;
            }
        }
    }

    private string GetMaxPlayers()
    {
        return maxPlayers.ToString();
    }

    private string GetAlertClass()
    {
        return errorType switch
        {
            ApiErrorType.ConnectionFailed => "alert-danger",
            ApiErrorType.Timeout => "alert-warning",
            _ => "alert-danger"
        };
    }

    private string GetErrorIcon()
    {
        return errorType switch
        {
            ApiErrorType.ConnectionFailed => "bi-wifi-off",
            ApiErrorType.Timeout => "bi-hourglass-split",
            ApiErrorType.ServerError => "bi-exclamation-triangle",
            _ => "bi-exclamation-circle"
        };
    }

    private string GetErrorTitle()
    {
        return errorType switch
        {
            ApiErrorType.ConnectionFailed => "Connection Failed",
            ApiErrorType.Timeout => "Request Timed Out",
            ApiErrorType.ServerError => "Server Error",
            _ => "Error"
        };
    }

    private void ToggleAutoRefresh()
    {
        autoRefreshEnabled = !autoRefreshEnabled;
    }

    private static string FormatUptime(TimeSpan uptime)
    {
        if (uptime.TotalDays >= 1)
        {
            return $"{(int)uptime.TotalDays}d {uptime.Hours}h";
        }
        if (uptime.TotalHours >= 1)
        {
            return $"{(int)uptime.TotalHours}h {uptime.Minutes}m";
        }
        if (uptime.TotalMinutes >= 1)
        {
            return $"{(int)uptime.TotalMinutes}m {uptime.Seconds}s";
        }
        return $"{uptime.Seconds}s";
    }

    private static string FormatTimeSpan(TimeSpan time)
    {
        if (time.TotalHours >= 1)
        {
            return $"{(int)time.TotalHours}:{time.Minutes:D2}:{time.Seconds:D2}";
        }
        return $"{time.Minutes}:{time.Seconds:D2}";
    }

    private static int GetMemoryPercent(double memoryMB, double maxMB = 2048)
    {
        var percent = (int)((memoryMB / maxMB) * 100);
        return Math.Min(100, Math.Max(1, percent));
    }

    public void Dispose()
    {
        refreshTimer?.Dispose();
    }
}
