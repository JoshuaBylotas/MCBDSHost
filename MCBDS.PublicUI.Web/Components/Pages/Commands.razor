@page "/commands"
@using MCBDS.ClientUI.Shared.Services
@using MCBDS.PublicUI.Web.Components
@inject BedrockApiService ApiService

<PageTitle>Commands</PageTitle>

<h1><i class="bi bi-terminal me-2"></i>Server Commands</h1>

<p>Send commands to the Minecraft Bedrock Dedicated Server.</p>

@if (!string.IsNullOrEmpty(connectionError))
{
    <div class="alert alert-danger" role="alert">
        <strong><i class="bi bi-wifi-off me-1"></i>Connection Error:</strong> @connectionError
        <button class="btn btn-outline-danger btn-sm ms-3" @onclick="RefreshLog">
            <i class="bi bi-arrow-clockwise me-1"></i>Retry
        </button>
    </div>
}

<div class="commands-container">
    <div class="command-input-section">
        <div class="input-group position-relative">
            <input @ref="commandInputElement"
                   @bind="commandInput" 
                   @bind:event="oninput"
                   @bind:after="UpdateSuggestions"
                   @onkeydown="HandleKeyDown"
                   @onfocus="HandleFocus"
                   @onblur="HandleBlur"
                   type="text" 
                   class="form-control" 
                   placeholder="Start typing a command (e.g., 'list', 'say Hello') - Press Ctrl+Space for suggestions"
                   disabled="@isProcessing"
                   autocomplete="off" />
            <button class="btn btn-primary" @onclick="SendCommand" disabled="@isProcessing">
                @if (isProcessing)
                {
                    <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                }
                else
                {
                    <i class="bi bi-send me-1"></i>
                }
                Send
            </button>
            
            @if (showSuggestions && filteredCommands.Any())
            {
                <div class="autocomplete-dropdown">
                    @foreach (var (cmd, index) in filteredCommands.Select((c, i) => (c, i)))
                    {
                        <div class="autocomplete-item @(index == selectedSuggestionIndex ? "selected" : "")"
                             @onmousedown="@(() => SelectCommand(cmd))"
                             @onmouseover="@(() => selectedSuggestionIndex = index)">
                            <div class="cmd-name">
                                <i class="bi bi-terminal-fill me-2"></i>
                                <strong>@cmd.Name</strong>
                                <span class="badge bg-secondary ms-2">@cmd.Category</span>
                            </div>
                            <div class="cmd-syntax"><small>@cmd.Syntax</small></div>
                            <div class="cmd-description"><small class="text-muted">@cmd.Description</small></div>
                        </div>
                    }
                </div>
            }

            @if (showPlayerSuggestions && filteredPlayers.Any())
            {
                <div class="autocomplete-dropdown player-dropdown">
                    <div class="dropdown-header">
                        <i class="bi bi-people-fill me-2"></i>
                        <strong>Online Players (@playerTracker.PlayerCount)</strong>
                    </div>
                    @foreach (var (player, index) in filteredPlayers.Select((p, i) => (p, i)))
                    {
                        <div class="autocomplete-item @(index == selectedPlayerIndex ? "selected" : "")"
                             @onmousedown="@(() => SelectPlayer(player))"
                             @onmouseover="@(() => selectedPlayerIndex = index)">
                            <div class="player-name">
                                <i class="bi bi-person-fill me-2 text-success"></i>
                                <strong>@player</strong>
                                <span class="badge bg-success ms-2">Online</span>
                            </div>
                        </div>
                    }
                </div>
            }

            @if (showItemSuggestions && filteredItems.Any())
            {
                <div class="autocomplete-dropdown item-dropdown">
                    <div class="dropdown-header">
                        <i class="bi bi-box-seam-fill me-2"></i>
                        <strong>@GetSuggestionsHeader()</strong>
                    </div>
                    @foreach (var (item, index) in filteredItems.Select((it, i) => (it, i)))
                    {
                        <div class="autocomplete-item @(index == selectedItemIndex ? "selected" : "")"
                             @onmousedown="@(() => SelectItem(item))"
                             @onmouseover="@(() => selectedItemIndex = index)">
                            <div class="item-name">
                                <i class="bi bi-cube-fill me-2 text-info"></i>
                                <strong>@item</strong>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
        
        @if (selectedCommand != null && !string.IsNullOrWhiteSpace(commandInput))
        {
            <div class="command-help mt-2">
                <div class="card border-info">
                    <div class="card-body p-2">
                        <h6 class="mb-1"><i class="bi bi-info-circle me-1"></i>@selectedCommand.Name</h6>
                        <p class="mb-1"><small>@selectedCommand.Description</small></p>
                        <div class="mb-1"><small><strong>Syntax:</strong> <code>@selectedCommand.Syntax</code></small></div>
                        @if (selectedCommand.Parameters.Any())
                        {
                            <div class="mb-1">
                                <small><strong>Parameters:</strong></small>
                                <ul class="mb-0" style="font-size: 0.8rem;">
                                    @foreach (var param in selectedCommand.Parameters)
                                    {
                                        <li>
                                            <code>@param.Name</code> (@param.Type)
                                            @if (param.Required) { <span class="badge bg-danger">Required</span> }
                                            else { <span class="badge bg-secondary">Optional</span> }
                                            - @param.Description
                                            @if (param.PossibleValues != null && param.PossibleValues.Any())
                                            {
                                                <div><em>Options: @string.Join(", ", param.PossibleValues)</em></div>
                                            }
                                        </li>
                                    }
                                </ul>
                            </div>
                        }
                        @if (selectedCommand.Examples.Any())
                        {
                            <div>
                                <small><strong>Examples:</strong></small>
                                <div>
                                    @foreach (var example in selectedCommand.Examples)
                                    {
                                        <div>
                                            <code class="clickable-example" @onclick="@(() => InsertExample(example))">@example</code>
                                            <small class="text-muted">(click to use)</small>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
        
        @if (!string.IsNullOrEmpty(statusMessage))
        {
            <div class="alert @statusClass mt-2" role="alert">
                @statusMessage
            </div>
        }
        
        <div class="mt-2">
            <button class="btn btn-sm btn-outline-secondary" @onclick="ShowCommandReference">
                <i class="bi bi-book me-1"></i>View All Commands
            </button>
        </div>
    </div>

    @if (showCommandReference)
    {
        <div class="command-reference mt-3">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-book me-2"></i>Command Reference</h5>
                    <button class="btn btn-sm btn-close" @onclick="@(() => showCommandReference = false)"></button>
                </div>
                <div class="card-body">
                    <input type="text" 
                           class="form-control mb-3" 
                           @bind="referenceSearchQuery" 
                           @bind:event="oninput"
                           placeholder="Search commands..." />
                    
                    @foreach (var category in GetFilteredCategories())
                    {
                        <div class="category-section mb-3">
                            <h6 class="text-primary"><i class="bi bi-folder me-1"></i>@category</h6>
                            <div class="row">
                                @foreach (var cmd in GetCommandsByCategory(category))
                                {
                                    <div class="col-md-6 mb-2">
                                        <div class="card border-light">
                                            <div class="card-body p-2">
                                                <div class="d-flex justify-content-between">
                                                    <strong>@cmd.Name</strong>
                                                    <button class="btn btn-sm btn-outline-primary btn-xs" 
                                                            @onclick="@(() => InsertCommand(cmd.Name))">
                                                        Use
                                                    </button>
                                                </div>
                                                <small class="text-muted">@cmd.Description</small>
                                                <div><small><code>@cmd.Syntax</code></small></div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    <div class="server-log-section">
        <div class="log-header">
            <h3><i class="bi bi-journal-text me-2"></i>Server Log</h3>
            <div class="log-buttons">
                <button class="btn btn-secondary btn-sm" @onclick="RefreshLog" disabled="@isLoadingLog" title="Refresh Log">
                    @if (isLoadingLog)
                    {
                        <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                    }
                    else
                    {
                        <i class="bi bi-arrow-clockwise me-1"></i>
                    }
                    Refresh
                </button>
                <button class="btn btn-warning btn-sm" @onclick="RestartServer" disabled="@isProcessing" title="Restart Server">
                    @if (isRestarting)
                    {
                        <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                    }
                    else
                    {
                        <i class="bi bi-arrow-repeat me-1"></i>
                    }
                    Restart
                </button>
            </div>
        </div>
        <pre class="server-log-content">@serverLog</pre>
    </div>
</div>

@code {
    private ElementReference commandInputElement;
    private string commandInput = string.Empty;
    private string serverLog = "Loading...";
    private string statusMessage = string.Empty;
    private string statusClass = "alert-info";
    private string? connectionError;
    private string referenceSearchQuery = string.Empty;
    private bool isProcessing = false;
    private bool isLoadingLog = false;
    private bool isRestarting = false;
    private bool showSuggestions = false;
    private bool showCommandReference = false;
    private bool showPlayerSuggestions = false;
    private bool showItemSuggestions = false;
    private int selectedSuggestionIndex = 0;
    private int selectedPlayerIndex = 0;
    private int selectedItemIndex = 0;
    private List<MinecraftCommand> filteredCommands = new();
    private List<string> filteredPlayers = new();
    private List<string> filteredItems = new();
    private MinecraftCommand? selectedCommand = null;
    private System.Threading.Timer? autoRefreshTimer;
    private readonly PlayerTracker playerTracker = new();
    private string? currentCommandName = null;
    private int currentParameterIndex = 0;

    protected override async Task OnInitializedAsync()
    {
        await RefreshLog();
        
        // Auto-refresh log every 3 seconds
        autoRefreshTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                if (!isProcessing && !isLoadingLog)
                {
                    await RefreshLog();
                }
            });
        }, null, TimeSpan.FromSeconds(3), TimeSpan.FromSeconds(3));
    }

    private void HandleFocus()
    {
        UpdateSuggestions();
    }

    private void HandleBlur()
    {
        // Delay hiding to allow click on suggestion
        Task.Delay(200).ContinueWith(_ => InvokeAsync(() =>
        {
            showSuggestions = false;
            showPlayerSuggestions = false;
            showItemSuggestions = false;
            StateHasChanged();
        }));
    }

    private void UpdateSuggestions()
    {
        if (string.IsNullOrWhiteSpace(commandInput))
        {
            showSuggestions = false;
            showPlayerSuggestions = false;
            showItemSuggestions = false;
            selectedCommand = null;
            return;
        }

        var parts = commandInput.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        var commandName = parts[0].ToLower();
        currentCommandName = commandName;
        
        // Calculate which parameter we're typing
        // Count spaces to determine if we're typing a new parameter
        var spaceCount = commandInput.Count(c => c == ' ');
        currentParameterIndex = spaceCount;

        // If we're on the first word, show command suggestions
        if (parts.Length == 1 && !commandInput.EndsWith(' '))
        {
            filteredCommands = BedrockCommands.SearchCommands(commandName).Take(10).ToList();
            showSuggestions = filteredCommands.Any();
            showPlayerSuggestions = false;
            showItemSuggestions = false;
            selectedSuggestionIndex = 0;
        }
        else
        {
            // We're typing parameters - check what type of parameter we need
            var cmd = BedrockCommands.GetCommand(commandName);
            if (cmd != null && currentParameterIndex > 0 && currentParameterIndex <= cmd.Parameters.Count)
            {
                var paramIndex = currentParameterIndex - 1; // Convert to 0-based index
                var param = cmd.Parameters[paramIndex];
                
                // Get the partial value being typed
                var partialValue = parts.Length > paramIndex + 1 ? parts[paramIndex + 1] : "";
                
                if (param.Type == "target")
                {
                    filteredPlayers = playerTracker.GetPlayerSuggestions(partialValue);
                    showPlayerSuggestions = filteredPlayers.Any();
                    showSuggestions = false;
                    showItemSuggestions = false;
                    selectedPlayerIndex = 0;
                }
                else if (param.Type == "string" && (param.Name.Contains("item") || commandName == "give" || commandName == "clear"))
                {
                    filteredItems = MinecraftItems.SearchItems(partialValue, 15);
                    showItemSuggestions = filteredItems.Any();
                    showSuggestions = false;
                    showPlayerSuggestions = false;
                    selectedItemIndex = 0;
                }
                else if (param.Type == "gamerule" && param.PossibleValues != null && param.PossibleValues.Any())
                {
                    // Show game rule suggestions
                    var lowerPartial = partialValue.ToLower();
                    filteredItems = param.PossibleValues
                        .Where(v => v.ToLower().Contains(lowerPartial))
                        .OrderBy(v => v.ToLower().StartsWith(lowerPartial) ? 0 : 1)
                        .ThenBy(v => v)
                        .Take(15)
                        .ToList();
                    showItemSuggestions = filteredItems.Any();
                    showSuggestions = false;
                    showPlayerSuggestions = false;
                    selectedItemIndex = 0;
                }
                else if (param.PossibleValues != null && param.PossibleValues.Any())
                {
                    // Show suggestions for any parameter with possible values
                    var lowerPartial = partialValue.ToLower();
                    filteredItems = param.PossibleValues
                        .Where(v => v.ToLower().Contains(lowerPartial))
                        .OrderBy(v => v.ToLower().StartsWith(lowerPartial) ? 0 : 1)
                        .ThenBy(v => v)
                        .Take(15)
                        .ToList();
                    showItemSuggestions = filteredItems.Any();
                    showSuggestions = false;
                    showPlayerSuggestions = false;
                    selectedItemIndex = 0;
                }
                else
                {
                    showSuggestions = false;
                    showPlayerSuggestions = false;
                    showItemSuggestions = false;
                }
            }
            else
            {
                showSuggestions = false;
                showPlayerSuggestions = false;
                showItemSuggestions = false;
            }
        }

        // Update selected command for help display
        selectedCommand = BedrockCommands.GetCommand(commandName);

        StateHasChanged();
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        // Handle player suggestions
        if (showPlayerSuggestions && filteredPlayers.Any())
        {
            if (e.Key == "ArrowDown")
            {
                selectedPlayerIndex = Math.Min(selectedPlayerIndex + 1, filteredPlayers.Count - 1);
                StateHasChanged();
                return;
            }
            else if (e.Key == "ArrowUp")
            {
                selectedPlayerIndex = Math.Max(selectedPlayerIndex - 1, 0);
                StateHasChanged();
                return;
            }
            else if (e.Key == "Tab" || (e.Key == "Enter" && showPlayerSuggestions))
            {
                if (selectedPlayerIndex < filteredPlayers.Count)
                {
                    SelectPlayer(filteredPlayers[selectedPlayerIndex]);
                }
                return;
            }
            else if (e.Key == "Escape")
            {
                showPlayerSuggestions = false;
                StateHasChanged();
                return;
            }
        }

        // Handle item suggestions
        if (showItemSuggestions && filteredItems.Any())
        {
            if (e.Key == "ArrowDown")
            {
                selectedItemIndex = Math.Min(selectedItemIndex + 1, filteredItems.Count - 1);
                StateHasChanged();
                return;
            }
            else if (e.Key == "ArrowUp")
            {
                selectedItemIndex = Math.Max(selectedItemIndex - 1, 0);
                StateHasChanged();
                return;
            }
            else if (e.Key == "Tab" || (e.Key == "Enter" && showItemSuggestions))
            {
                if (selectedItemIndex < filteredItems.Count)
                {
                    SelectItem(filteredItems[selectedItemIndex]);
                }
                return;
            }
            else if (e.Key == "Escape")
            {
                showItemSuggestions = false;
                StateHasChanged();
                return;
            }
        }

        // Handle command suggestions
        if (showSuggestions && filteredCommands.Any())
        {
            if (e.Key == "ArrowDown")
            {
                selectedSuggestionIndex = Math.Min(selectedSuggestionIndex + 1, filteredCommands.Count - 1);
                StateHasChanged();
                return;
            }
            else if (e.Key == "ArrowUp")
            {
                selectedSuggestionIndex = Math.Max(selectedSuggestionIndex - 1, 0);
                StateHasChanged();
                return;
            }
            else if (e.Key == "Tab" || (e.Key == "Enter" && showSuggestions))
            {
                if (selectedSuggestionIndex < filteredCommands.Count)
                {
                    SelectCommand(filteredCommands[selectedSuggestionIndex]);
                }
                return;
            }
            else if (e.Key == "Escape")
            {
                showSuggestions = false;
                StateHasChanged();
                return;
            }
        }

        if (e.Key == "Enter" && !isProcessing)
        {
            _ = SendCommand();
        }
        else if (e.Key == " " && e.CtrlKey)
        {
            UpdateSuggestions();
            showSuggestions = true;
            StateHasChanged();
        }
    }

    private void SelectCommand(MinecraftCommand cmd)
    {
        var parts = commandInput.Split(' ');
        if (parts.Length > 1)
        {
            // Keep existing parameters if any
            commandInput = cmd.Name + " " + string.Join(" ", parts.Skip(1));
        }
        else
        {
            commandInput = cmd.Name + " ";
        }
        
        selectedCommand = cmd;
        showSuggestions = false;
        StateHasChanged();
    }

    private void SelectPlayer(string playerName)
    {
        var parts = commandInput.Split(' ').ToList();
        var paramIndex = currentParameterIndex;
        
        // If we have enough parts, replace the current parameter
        if (parts.Count > paramIndex)
        {
            parts[paramIndex] = playerName;
        }
        else
        {
            // Add the player name
            while (parts.Count < paramIndex)
            {
                parts.Add("");
            }
            parts.Add(playerName);
        }
        
        commandInput = string.Join(" ", parts.Where(p => !string.IsNullOrEmpty(p))) + " ";
        showPlayerSuggestions = false;
        StateHasChanged();
    }

    private void SelectItem(string itemName)
    {
        var parts = commandInput.Split(' ').ToList();
        var paramIndex = currentParameterIndex;
        
        // If we have enough parts, replace the current parameter
        if (parts.Count > paramIndex)
        {
            parts[paramIndex] = itemName;
        }
        else
        {
            // Add the item name
            while (parts.Count < paramIndex)
            {
                parts.Add("");
            }
            parts.Add(itemName);
        }
        
        commandInput = string.Join(" ", parts.Where(p => !string.IsNullOrEmpty(p))) + " ";
        showItemSuggestions = false;
        StateHasChanged();
    }

    private void InsertCommand(string cmdName)
    {
        commandInput = cmdName + " ";
        selectedCommand = BedrockCommands.GetCommand(cmdName);
        showCommandReference = false;
        StateHasChanged();
    }

    private void InsertExample(string example)
    {
        commandInput = example;
        selectedCommand = BedrockCommands.GetCommand(example.Split(' ')[0]);
        StateHasChanged();
    }

    private void ShowCommandReference()
    {
        showCommandReference = !showCommandReference;
        StateHasChanged();
    }

    private string GetSuggestionsHeader()
    {
        var cmd = BedrockCommands.GetCommand(currentCommandName ?? "");
        if (cmd != null && currentParameterIndex > 0 && currentParameterIndex <= cmd.Parameters.Count)
        {
            var paramIndex = currentParameterIndex - 1;
            var param = cmd.Parameters[paramIndex];
            
            return param.Type switch
            {
                "gamerule" => "Game Rules",
                "string" when param.Name.Contains("item") => "Minecraft Items",
                _ when param.PossibleValues != null && param.PossibleValues.Any() => $"{param.Name} Options",
                _ => "Suggestions"
            };
        }
        return "Suggestions";
    }

    private List<string> GetFilteredCategories()
    {
        if (string.IsNullOrWhiteSpace(referenceSearchQuery))
            return BedrockCommands.GetCategories();

        var query = referenceSearchQuery.ToLower();
        return BedrockCommands.All
            .Where(cmd => cmd.Name.ToLower().Contains(query) || 
                          cmd.Description.ToLower().Contains(query) ||
                          cmd.Category.ToLower().Contains(query))
            .Select(cmd => cmd.Category)
            .Distinct()
            .OrderBy(c => c)
            .ToList();
    }

    private List<MinecraftCommand> GetCommandsByCategory(string category)
    {
        var commands = BedrockCommands.All.Where(cmd => cmd.Category == category);
        
        if (!string.IsNullOrWhiteSpace(referenceSearchQuery))
        {
            var query = referenceSearchQuery.ToLower();
            commands = commands.Where(cmd => 
                cmd.Name.ToLower().Contains(query) || 
                cmd.Description.ToLower().Contains(query));
        }
        
        return commands.OrderBy(cmd => cmd.Name).ToList();
    }

    private async Task SendCommand()
    {
        if (string.IsNullOrWhiteSpace(commandInput))
        {
            SetStatus("Please enter a command", "alert-warning");
            return;
        }

        isProcessing = true;
        statusMessage = string.Empty;
        connectionError = null;
        StateHasChanged();

        var result = await ApiService.SendLineAsync(commandInput);
        
        if (result.Success)
        {
            SetStatus($"Command sent: {commandInput}", "alert-success");
            
            // If it was a "list" command, refresh to update player list
            if (commandInput.Trim().ToLower() == "list")
            {
                await Task.Delay(1000); // Wait for server to respond
            }
            
            commandInput = string.Empty;
            selectedCommand = null;
            await Task.Delay(500);
            await RefreshLog();
        }
        else
        {
            if (result.ErrorType == ApiErrorType.ConnectionFailed)
            {
                connectionError = result.ErrorMessage;
            }
            SetStatus(result.ErrorMessage ?? "Failed to send command", "alert-danger");
        }
        
        isProcessing = false;
        StateHasChanged();
    }

    private async Task RefreshLog()
    {
        isLoadingLog = true;
        connectionError = null;
        
        var result = await ApiService.GetLogAsync();
        
        if (result.Success)
        {
            serverLog = result.Data ?? "No log data available.";
            
            // Parse log to update player tracker
            playerTracker.ParseLog(serverLog);
        }
        else
        {
            serverLog = "Unable to load log.";
            connectionError = result.ErrorMessage;
        }
        
        isLoadingLog = false;
        StateHasChanged();
    }

    private async Task RestartServer()
    {
        isRestarting = true;
        isProcessing = true;
        connectionError = null;
        SetStatus("Restarting server...", "alert-info");
        
        // Clear player list on restart
        playerTracker.Clear();
        
        StateHasChanged();

        var result = await ApiService.RestartAsync();
        
        if (result.Success)
        {
            SetStatus("Server restarted successfully", "alert-success");
            await Task.Delay(2000);
            await RefreshLog();
        }
        else
        {
            if (result.ErrorType == ApiErrorType.ConnectionFailed)
            {
                connectionError = result.ErrorMessage;
            }
            SetStatus(result.ErrorMessage ?? "Failed to restart server", "alert-danger");
        }
        
        isRestarting = false;
        isProcessing = false;
        StateHasChanged();
    }

    private void SetStatus(string message, string cssClass)
    {
        statusMessage = message;
        statusClass = cssClass;
    }

    public void Dispose()
    {
        autoRefreshTimer?.Dispose();
    }
}
