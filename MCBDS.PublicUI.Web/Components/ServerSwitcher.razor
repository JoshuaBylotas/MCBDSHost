@using MCBDS.ClientUI.Shared.Services
@inject IServerConfigService ServerConfig
@inject NavigationManager Navigation

<div class="server-switcher">
    <div class="server-selector">
        @if (!isEditing && editingServer == null)
        {
            <div class="d-flex align-items-center gap-2">
                <select class="form-select form-select-sm server-select flex-grow-1" @onchange="OnServerSelected" value="@currentServerUrl">
                    @foreach (var server in savedServers)
                    {
                        <option value="@server.Url" selected="@(server.Url == currentServerUrl)">@server.Name</option>
                    }
                    <option value="__add_new__">+ Add New Server...</option>
                </select>
                
                @if (savedServers.Count > 1 && !string.IsNullOrEmpty(currentServerUrl))
                {
                    <button class="btn btn-sm btn-outline-secondary" @onclick="StartEditServer" title="Edit Server">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" @onclick="() => ConfirmDeleteServer()" title="Delete Server">
                        <i class="bi bi-trash"></i>
                    </button>
                }
            </div>
            
            @if (!string.IsNullOrEmpty(statusMessage))
            {
                <span class="status-indicator @statusClass">@statusMessage</span>
            }
            
            @if (showDeleteConfirm)
            {
                <div class="delete-confirm mt-2 p-2 border rounded bg-light">
                    <p class="mb-2 small">Delete server "@GetCurrentServerName()"?</p>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-danger" @onclick="DeleteCurrentServer">
                            <i class="bi bi-check-lg"></i> Yes, Delete
                        </button>
                        <button class="btn btn-sm btn-secondary" @onclick="CancelDelete">
                            <i class="bi bi-x-lg"></i> Cancel
                        </button>
                    </div>
                </div>
            }
        }
        else if (editingServer != null)
        {
            <div class="edit-server-form">
                <input type="text" class="form-control form-control-sm" 
                       placeholder="Server Name" 
                       @bind="editingServer.Name" />
                <input type="text" class="form-control form-control-sm"
                       placeholder="URL (http://192.168.1.100:8080)" 
                       @bind="editingServer.Url" />
                <button class="btn btn-sm btn-success" @onclick="SaveEditedServer" title="Save Changes">
                    <i class="bi bi-check-lg"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary" @onclick="CancelEdit" title="Cancel">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        }
        else if (isEditing)
        {
            <div class="add-server-form">
                <input type="text" class="form-control form-control-sm" 
                       placeholder="Server Name" 
                       @bind="newServerName" />
                <input type="text" class="form-control form-control-sm"
                       placeholder="URL (http://192.168.1.100:8080)" 
                       @bind="newServerUrl" />
                <button class="btn btn-sm btn-success" @onclick="AddNewServer" title="Add Server">
                    <i class="bi bi-check-lg"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary" @onclick="CancelAdd" title="Cancel">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        }
    </div>
</div>

@code {
    private string currentServerUrl = "";
    private List<SavedServer> savedServers = new();
    private bool isEditing = false;
    private SavedServer? editingServer = null;
    private bool showDeleteConfirm = false;
    private string newServerName = "";
    private string newServerUrl = "";
    private string statusMessage = "";
    private string statusClass = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadServers();
        ServerConfig.OnServerChanged += HandleServerChanged;
    }

    private async Task LoadServers()
    {
        var config = await ServerConfig.LoadConfigAsync();
        currentServerUrl = config.CurrentServerUrl;
        savedServers = config.SavedServers ?? new List<SavedServer>();
        StateHasChanged();
    }

    private void HandleServerChanged()
    {
        _ = InvokeAsync(async () =>
        {
            await LoadServers();
            StateHasChanged();
        });
    }

    private string GetCurrentServerName()
    {
        return savedServers.FirstOrDefault(s => s.Url == currentServerUrl)?.Name ?? currentServerUrl;
    }

    private void StartEditServer()
    {
        var currentServer = savedServers.FirstOrDefault(s => s.Url == currentServerUrl);
        if (currentServer != null)
        {
            editingServer = new SavedServer 
            { 
                Name = currentServer.Name, 
                Url = currentServer.Url 
            };
            showDeleteConfirm = false;
        }
    }

    private async Task SaveEditedServer()
    {
        if (editingServer == null || string.IsNullOrWhiteSpace(editingServer.Name) || string.IsNullOrWhiteSpace(editingServer.Url))
        {
            return;
        }

        var oldUrl = currentServerUrl;
        var newUrl = NormalizeUrl(editingServer.Url);

        // Remove old server and add updated one
        await ServerConfig.RemoveServerAsync(oldUrl);
        await ServerConfig.AddServerAsync(editingServer.Name, newUrl);
        
        // Switch to the updated server
        await ServerConfig.SwitchServerAsync(newUrl);
        await LoadServers();
        
        editingServer = null;
        
        // Reload page to reflect changes
        Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
    }

    private void CancelEdit()
    {
        editingServer = null;
        StateHasChanged();
    }

    private void ConfirmDeleteServer()
    {
        showDeleteConfirm = true;
        StateHasChanged();
    }

    private async Task DeleteCurrentServer()
    {
        if (savedServers.Count <= 1)
        {
            statusMessage = "Cannot delete the last server";
            statusClass = "status-error";
            showDeleteConfirm = false;
            StateHasChanged();
            return;
        }

        var success = await ServerConfig.RemoveServerAsync(currentServerUrl);
        
        if (success)
        {
            await LoadServers();
            showDeleteConfirm = false;
            
            // The service automatically switches to another server
            // Reload to reflect the new server
            Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
        }
        else
        {
            statusMessage = "Delete failed";
            statusClass = "status-error";
            showDeleteConfirm = false;
            StateHasChanged();
        }
    }

    private void CancelDelete()
    {
        showDeleteConfirm = false;
        StateHasChanged();
    }

    private async Task OnServerSelected(ChangeEventArgs e)
    {
        var selectedValue = e.Value?.ToString();
        
        if (selectedValue == "__add_new__")
        {
            isEditing = true;
            newServerName = "";
            newServerUrl = "";
            showDeleteConfirm = false;
            return;
        }
        
        if (!string.IsNullOrEmpty(selectedValue) && selectedValue != currentServerUrl)
        {
            statusMessage = "Switching...";
            statusClass = "status-switching";
            showDeleteConfirm = false;
            StateHasChanged();
            
            var success = await ServerConfig.SwitchServerAsync(selectedValue);
            
            if (success)
            {
                currentServerUrl = selectedValue;
                statusMessage = "Connected";
                statusClass = "status-success";
                StateHasChanged();
                
                // Force a page refresh to reload data from new server
                await Task.Delay(500);
                Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
            }
            else
            {
                statusMessage = "Failed";
                statusClass = "status-error";
                StateHasChanged();
                
                // Clear status after 3 seconds
                await Task.Delay(3000);
                statusMessage = "";
                StateHasChanged();
            }
        }
    }

    private async Task AddNewServer()
    {
        if (string.IsNullOrWhiteSpace(newServerName) || string.IsNullOrWhiteSpace(newServerUrl))
        {
            return;
        }
        
        var success = await ServerConfig.AddServerAsync(newServerName, newServerUrl);
        
        if (success)
        {
            // Switch to the new server
            var normalizedUrl = NormalizeUrl(newServerUrl);
            
            await ServerConfig.SwitchServerAsync(normalizedUrl);
            await LoadServers();
            
            // Force a page refresh to reload data from new server
            Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
        }
        
        isEditing = false;
        newServerName = "";
        newServerUrl = "";
    }

    private void CancelAdd()
    {
        isEditing = false;
        newServerName = "";
        newServerUrl = "";
        StateHasChanged();
    }

    private static string NormalizeUrl(string url)
    {
        // Remove any protocol prefix (valid or malformed like hpps://, htps://, etc.)
        var protocolIndex = url.IndexOf("://", StringComparison.OrdinalIgnoreCase);
        if (protocolIndex > 0)
        {
            var protocol = url.Substring(0, protocolIndex).ToLowerInvariant();
            // Only keep valid protocols, strip invalid ones
            if (protocol == "http" || protocol == "https")
            {
                // Valid protocol, keep as-is but normalize to lowercase
                url = protocol + url.Substring(protocolIndex);
            }
            else
            {
                // Invalid protocol, strip it
                url = url.Substring(protocolIndex + 3);
            }
        }
        
        // Add http:// if no protocol (case-insensitive check)
        if (!url.StartsWith("http://", StringComparison.OrdinalIgnoreCase) && 
            !url.StartsWith("https://", StringComparison.OrdinalIgnoreCase))
        {
            url = "http://" + url;
        }
        
        // Remove trailing slash
        url = url.TrimEnd('/');
        
        return url;
    }

    public void Dispose()
    {
        ServerConfig.OnServerChanged -= HandleServerChanged;
    }
}
