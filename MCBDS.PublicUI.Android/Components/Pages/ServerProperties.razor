@page "/server-properties"
@using MCBDS.ClientUI.Shared.Services
@inject BedrockApiService ApiService

<PageTitle>Server Properties</PageTitle>

<h1><i class="bi bi-gear me-2"></i>Server Properties</h1>

<p>View the current Minecraft Bedrock server configuration.</p>

@if (isLoading)
{
    <div class="text-center my-5">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading server properties...</p>
    </div>
}
else if (errorMessage != null)
{
    <div class="alert alert-danger" role="alert">
        <h5><i class="bi bi-exclamation-triangle me-1"></i>Error Loading Properties</h5>
        <p>@errorMessage</p>
        <button class="btn btn-outline-danger btn-sm" @onclick="LoadProperties">
            <i class="bi bi-arrow-clockwise me-1"></i>Try Again
        </button>
    </div>
    
    @if (errorType == ApiErrorType.ConnectionFailed)
    {
        <div class="card border-warning mt-3">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-lightbulb me-1"></i>Troubleshooting Tips</h5>
                <ul class="mb-0">
                    <li>Make sure the API server is running</li>
                    <li>Check if the server URL is correct (use the Server dropdown above)</li>
                    <li>Verify the server.properties file exists on the server</li>
                </ul>
            </div>
        </div>
    }
}
else if (serverProperties != null)
{
    <div class="row mb-3">
        <div class="col">
            <div class="card bg-light">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">
                                <strong>@serverProperties.TotalProperties</strong> properties loaded from
                                <code>@serverProperties.Path</code>
                            </small>
                            <br />
                            <small class="text-muted">
                                <i class="bi bi-clock me-1"></i>Last modified: @serverProperties.LastModified.ToString("g")
                            </small>
                        </div>
                        <button class="btn btn-outline-primary btn-sm" @onclick="LoadProperties" disabled="@isLoading">
                            @if (isLoading)
                            {
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            }
                            else
                            {
                                <i class="bi bi-arrow-clockwise me-1"></i>
                            }
                            Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="alert alert-info" role="alert">
        <i class="bi bi-info-circle me-1"></i>
        <strong>Read-Only View</strong> - These settings are loaded from the server's <code>server.properties</code> file. 
        To modify settings, edit the file directly on the server and restart the Bedrock server.
    </div>

    @if (serverProperties.Categories != null)
    {
        <div class="accordion" id="propertiesAccordion">
            @foreach (var category in serverProperties.Categories)
            {
                var categoryId = category.Category.Replace(" ", "").Replace("&", "And");
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button @(IsExpanded(categoryId) ? "" : "collapsed")" 
                                type="button" 
                                @onclick="() => ToggleCategory(categoryId)">
                            <i class="bi @GetCategoryIcon(category.Category) me-2"></i>
                            <strong>@category.Category</strong>
                            <span class="badge bg-secondary ms-2">@(category.Properties?.Count ?? 0)</span>
                        </button>
                    </h2>
                    <div class="accordion-collapse collapse @(IsExpanded(categoryId) ? "show" : "")">
                        <div class="accordion-body p-0">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 30%">Property</th>
                                        <th style="width: 25%">Value</th>
                                        <th>Description</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (category.Properties != null)
                                    {
                                        @foreach (var prop in category.Properties)
                                        {
                                            <tr>
                                                <td>
                                                    <code>@prop.Key</code>
                                                </td>
                                                <td>
                                                    @if (IsBooleanValue(prop.Value))
                                                    {
                                                        @if (prop.Value.ToLower() == "true")
                                                        {
                                                            <span class="badge bg-success"><i class="bi bi-check-lg"></i> true</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-secondary"><i class="bi bi-x-lg"></i> false</span>
                                                        }
                                                    }
                                                    else if (IsNumericValue(prop.Value))
                                                    {
                                                        <span class="badge bg-primary">@prop.Value</span>
                                                    }
                                                    else if (string.IsNullOrEmpty(prop.Value))
                                                    {
                                                        <em class="text-muted">(empty)</em>
                                                    }
                                                    else
                                                    {
                                                        <span>@prop.Value</span>
                                                    }
                                                </td>
                                                <td>
                                                    @if (!string.IsNullOrEmpty(prop.Description))
                                                    {
                                                        <small class="text-muted">@prop.Description</small>
                                                    }
                                                    else
                                                    {
                                                        <small class="text-muted fst-italic">No description available</small>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    <div class="card mt-4">
        <div class="card-body">
            <h5 class="card-title"><i class="bi bi-info-circle me-1"></i>Information</h5>
            <ul class="mb-0">
                <li>Server properties are loaded from the Bedrock server's <code>server.properties</code> file</li>
                <li>Some properties are only applied when the world is first created</li>
                <li>Changes to server.properties require a server restart to take effect</li>
                <li>Use the Commands page to change some settings at runtime (like difficulty)</li>
            </ul>
        </div>
    </div>
}

@code {
    private ServerPropertiesResponse? serverProperties;
    private bool isLoading = true;
    private string? errorMessage;
    private ApiErrorType errorType = ApiErrorType.None;
    private HashSet<string> expandedCategories = new() { "Server", "Gameplay", "World" };

    protected override async Task OnInitializedAsync()
    {
        await LoadProperties();
    }

    private async Task LoadProperties()
    {
        isLoading = true;
        errorMessage = null;
        errorType = ApiErrorType.None;
        StateHasChanged();

        var result = await ApiService.GetServerPropertiesAsync();
        
        if (result.Success && result.Data != null)
        {
            serverProperties = result.Data;
        }
        else
        {
            errorMessage = result.ErrorMessage ?? "Could not load server properties.";
            errorType = result.ErrorType;
        }
        
        isLoading = false;
        StateHasChanged();
    }

    private bool IsExpanded(string categoryId) => expandedCategories.Contains(categoryId);

    private void ToggleCategory(string categoryId)
    {
        if (expandedCategories.Contains(categoryId))
        {
            expandedCategories.Remove(categoryId);
        }
        else
        {
            expandedCategories.Add(categoryId);
        }
    }

    private static bool IsBooleanValue(string value)
    {
        return value.ToLower() == "true" || value.ToLower() == "false";
    }

    private static bool IsNumericValue(string value)
    {
        return int.TryParse(value, out _) || double.TryParse(value, out _);
    }

    private static string GetCategoryIcon(string category)
    {
        return category switch
        {
            "Server" => "bi-hdd-stack",
            "Gameplay" => "bi-controller",
            "World" => "bi-globe",
            "Players & Permissions" => "bi-people",
            "Performance" => "bi-speedometer2",
            "Network" => "bi-wifi",
            "Anti-Cheat" => "bi-shield-check",
            "Client" => "bi-phone",
            "Miscellaneous" => "bi-three-dots",
            _ => "bi-question-circle"
        };
    }
}
