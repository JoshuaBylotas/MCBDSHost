@page "/connection-test"
@inject MCBDS.ClientUI.Shared.Services.BedrockApiService ApiService
@inject MCBDS.ClientUI.Shared.Services.ServerConfigService ServerConfig

<h3>Connection Diagnostics</h3>

<div class="card mb-3">
    <div class="card-header">Current Configuration</div>
    <div class="card-body">
        <p><strong>Server URL:</strong> @currentUrl</p>
        <p><strong>Status:</strong> <span class="@statusClass">@status</span></p>
    </div>
</div>

<div class="card mb-3">
    <div class="card-header">Test Connection</div>
    <div class="card-body">
        <button class="btn btn-primary" @onclick="TestConnection" disabled="@isTesting">
            @if (isTesting)
            {
                <span class="spinner-border spinner-border-sm me-2"></span>
            }
            Test Connection
        </button>
        
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger mt-3">
                <strong>Error:</strong> @errorMessage
            </div>
        }
        
        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success mt-3">
                <strong>Success:</strong> @successMessage
            </div>
        }
    </div>
</div>

<div class="card mb-3">
    <div class="card-header">Test Different URL</div>
    <div class="card-body">
        <input type="text" class="form-control mb-2" @bind="testUrl" placeholder="http://WINSERVER03.bylotas.net:8081" />
        <button class="btn btn-secondary" @onclick="TestCustomUrl" disabled="@isTesting">
            Test Custom URL
        </button>
    </div>
</div>

<div class="card">
    <div class="card-header">Debug Information</div>
    <div class="card-body">
        <pre style="font-size: 0.8rem; white-space: pre-wrap;">@debugInfo</pre>
    </div>
</div>

<style>
    .status-ok { color: green; font-weight: bold; }
    .status-error { color: red; font-weight: bold; }
    .status-testing { color: orange; font-weight: bold; }
</style>

@code {
    private string currentUrl = "";
    private string testUrl = "";
    private string status = "Unknown";
    private string statusClass = "";
    private string errorMessage = "";
    private string successMessage = "";
    private string debugInfo = "";
    private bool isTesting = false;

    protected override async Task OnInitializedAsync()
    {
        currentUrl = ServerConfig.GetCurrentServerUrl();
        testUrl = currentUrl;
        UpdateDebugInfo();
    }

    private async Task TestConnection()
    {
        await TestUrl(currentUrl);
    }

    private async Task TestCustomUrl()
    {
        if (string.IsNullOrWhiteSpace(testUrl))
            return;
        await TestUrl(testUrl);
    }

    private async Task TestUrl(string url)
    {
        isTesting = true;
        status = "Testing...";
        statusClass = "status-testing";
        errorMessage = "";
        successMessage = "";
        StateHasChanged();

        try
        {
            UpdateDebugInfo($"Testing connection to: {url}");
            
            // Create a test HttpClient
            using var client = new HttpClient(new Xamarin.Android.Net.AndroidMessageHandler
            {
                ServerCertificateCustomValidationCallback = (message, cert, chain, errors) => true,
                AutomaticDecompression = System.Net.DecompressionMethods.GZip | System.Net.DecompressionMethods.Deflate
            })
            {
                Timeout = TimeSpan.FromSeconds(30)
            };

            // Normalize URL
            if (!url.StartsWith("http://") && !url.StartsWith("https://"))
                url = "http://" + url;

            var testEndpoint = url.TrimEnd('/') + "/health";
            
            UpdateDebugInfo($"Attempting to connect to: {testEndpoint}");
            
            var response = await client.GetAsync(testEndpoint);
            
            UpdateDebugInfo($"Response Status: {response.StatusCode}");
            UpdateDebugInfo($"Response Headers: {string.Join(", ", response.Headers.Select(h => $"{h.Key}={string.Join(",", h.Value)}"))}");
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                status = "Connected";
                statusClass = "status-ok";
                successMessage = $"Successfully connected! Status: {response.StatusCode}";
                UpdateDebugInfo($"Response Body: {content}");
            }
            else
            {
                status = "Failed";
                statusClass = "status-error";
                errorMessage = $"Server returned status: {response.StatusCode}";
                UpdateDebugInfo($"Failed with status code: {response.StatusCode}");
            }
        }
        catch (System.Net.Http.HttpRequestException ex)
        {
            status = "Connection Error";
            statusClass = "status-error";
            errorMessage = $"HTTP Error: {ex.Message}";
            UpdateDebugInfo($"HttpRequestException: {ex}");
        }
        catch (TaskCanceledException ex)
        {
            status = "Timeout";
            statusClass = "status-error";
            errorMessage = "Connection timed out. Server may be unreachable.";
            UpdateDebugInfo($"TaskCanceledException: {ex}");
        }
        catch (Exception ex)
        {
            status = "Error";
            statusClass = "status-error";
            errorMessage = $"Unexpected error: {ex.Message}";
            UpdateDebugInfo($"Exception: {ex}");
        }
        finally
        {
            isTesting = false;
            StateHasChanged();
        }
    }

    private void UpdateDebugInfo(string newInfo = null)
    {
        if (newInfo != null)
        {
            debugInfo += $"\n[{DateTime.Now:HH:mm:ss}] {newInfo}";
        }
        else
        {
            debugInfo = $"Current Server: {currentUrl}\n";
            debugInfo += $"App Data Directory: {FileSystem.Current.AppDataDirectory}\n";
            debugInfo += $"Platform: Android\n";
            debugInfo += $"Time: {DateTime.Now}\n";
        }
    }
}
